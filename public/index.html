<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate, max-age=0" />
    <meta http-equiv="Pragma" content="no-cache" />
    <meta http-equiv="Expires" content="0" />
    <meta name="version" content="2025-11-30-v7" />
    <title>PassFortress - Secure Password Manager</title>
    <script>
        // å¼ºåˆ¶æ¸…é™¤ç¼“å­˜å¹¶é‡æ–°åŠ è½½
        const CURRENT_VERSION = '2025-11-30-v7';
        const storedVersion = localStorage.getItem('app-version');
        if (storedVersion !== CURRENT_VERSION) {
            console.log('New version detected, clearing cache...');
            localStorage.setItem('app-version', CURRENT_VERSION);
            // æ¸…é™¤æ‰€æœ‰ç¼“å­˜
            if ('caches' in window) {
                caches.keys().then(names => {
                    names.forEach(name => caches.delete(name));
                });
            }
            // å¦‚æœä¸æ˜¯ç¬¬ä¸€æ¬¡æ£€æµ‹åˆ°ç‰ˆæœ¬ä¸åŒï¼Œå¼ºåˆ¶åˆ·æ–°
            if (storedVersion !== null && window.location.search.indexOf('v=') === -1) {
                window.location.href = window.location.pathname + '?v=' + Date.now();
            }
        }
    </script>
    <link rel="stylesheet" href="/tailwind.generated.css" />
    <script src="https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        html {
            font-family: 'Inter', sans-serif;
        }
        body {
            background-color: #0f172a;
        }
        .fade-in {
            animation: fadeIn 0.3s ease;
        }
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        .password-item {
            animation: slideIn 0.3s ease;
        }
        @keyframes slideIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .animate-slideIn {
            animation: slideInFromRight 0.3s ease;
        }
        @keyframes slideInFromRight {
            from { opacity: 0; transform: translateX(100px); }
            to { opacity: 1; transform: translateX(0); }
        }
        /* Client specific tweaks */
        body.client-desktop .btn-hover { transition: transform .12s ease, box-shadow .12s ease; }
        body.client-desktop .btn-hover:hover { transform: translateY(-1px); box-shadow: 0 6px 20px rgba(0,0,0,.25); }
        body.client-mobile .btn-hover { transition: none; }
        /* Enhanced icon buttons */
        .icon-btn {
            font-size: 1.25rem;
            line-height: 1;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            min-width: 2.5rem;
            min-height: 2.5rem;
            transition: all 0.2s ease;
        }
        .icon-btn:hover {
            transform: scale(1.1) translateY(-2px);
            box-shadow: 0 8px 24px rgba(0,0,0,0.3);
        }
        .icon-btn:active {
            transform: scale(0.95);
        }
        /* Generator panel overflow guard */
        .panel-scroll { overflow: hidden; }
        .panel-scroll .panel-inner { max-height: 420px; overflow-y: auto; word-break: break-word; }
        .mono-wrap { word-break: break-all; }
    </style>
</head>
<body class="text-gray-200">
    <script src="https://challenges.cloudflare.com/turnstile/v0/api.js" async defer></script>
    <div id="app"></div>

    <script>
        const API_BASE = window.location.origin;
        // Fetch public runtime config (Turnstile sitekey, domain)
        let __PUBLIC_CONFIG = { sitekey: '', domain: '' };
        async function loadPublicConfig() {
            try {
                const res = await fetch(`${API_BASE}/api/config`);
                if (res.ok) {
                    __PUBLIC_CONFIG = await res.json();
                }
            } catch(e) {}
        }
        // Turnstile minimal integration: render and keep latest token
        window.__turnstileToken = '';
        async function setupTurnstile() {
            if (!__PUBLIC_CONFIG.sitekey) { await loadPublicConfig(); }
            if (!window.turnstile) { setTimeout(setupTurnstile, 500); return; }
            const container = document.createElement('div');
            container.id = 'cf-turnstile';
            container.className = 'fixed bottom-2 right-2';
            document.body.appendChild(container);
            try {
                window.turnstile.render('#cf-turnstile', {
                    sitekey: __PUBLIC_CONFIG.sitekey || 'CHANGE_ME_SITEKEY',
                    size: 'invisible',
                    callback: function(token) { window.__turnstileToken = token; },
                    'error-callback': function(){ window.__turnstileToken = ''; },
                    'timeout-callback': function(){ window.__turnstileToken = ''; }
                });
                // åˆæ¬¡æ‰§è¡Œä»¥è·å–ä»¤ç‰Œ
                window.turnstile.execute('#cf-turnstile');
            } catch(e) { /* ignore */ }
        }
        setupTurnstile();

        // å¯è§†åŒ–çŠ¶æ€å¾½ç« ï¼ˆè”è°ƒç”¨ï¼‰
        (function renderTokenBadge(){
            const badge = document.createElement('div');
            badge.id = 'cf-badge';
            badge.className = 'fixed bottom-2 left-2 px-3 py-1 rounded bg-black/50 text-xs';
            badge.style.zIndex = '9999';
            document.body.appendChild(badge);
            setInterval(()=>{
                const has = !!window.__turnstileToken;
                badge.textContent = has ? 'Turnstile: OK' : 'Turnstile: WAITING';
                badge.style.backgroundColor = has ? '#064e3b' : '#4b5563';
            }, 500);
        })();

        // è·å–æœ€æ–° Turnstile ä»¤ç‰Œï¼ˆæ‰§è¡Œå¹¶ç­‰å¾…å›è°ƒï¼‰
        async function getTurnstileToken(action = '') {
            try {
                if (!window.turnstile) return '';
                window.__turnstileToken = '';
                window.turnstile.execute('#cf-turnstile', { action });
                const deadline = Date.now() + 4000; // æœ€é•¿ç­‰å¾… 4 ç§’
                while (Date.now() < deadline) {
                    await new Promise(r => setTimeout(r, 120));
                    if (window.__turnstileToken) return window.__turnstileToken;
                }
            } catch(e) {}
            // è‹¥æ— æ³•è·å–ä»¤ç‰Œï¼Œåˆ‡æ¢ä¸ºå¯è§†æ¨¡å¼ï¼Œæç¤ºç”¨æˆ·ç‚¹å‡»éªŒè¯
            try {
                const host = document.getElementById('cf-turnstile');
                if (host) {
                    host.innerHTML = '';
                    window.turnstile.render('#cf-turnstile', {
                        sitekey: __PUBLIC_CONFIG.sitekey || 'CHANGE_ME_SITEKEY',
                        size: 'compact',
                        callback: function(token) { window.__turnstileToken = token; },
                        'error-callback': function(){ window.__turnstileToken = ''; },
                        'timeout-callback': function(){ window.__turnstileToken = ''; }
                    });
                }
            } catch(e) {}
            return '';
        }

        class PasswordManager {
            constructor() {
                this.state = {
                    screen: 'login', // login, register, app
                    user: null,
                    token: null,
                    passwords: [],
                    allPasswords: [], // Unfiltered passwords for search
                    showPassword: false,
                    generatedPassword: '',
                    newWebsite: '',
                    newUsername: '',
                    newPassword: '',
                    email: '',
                    password: '',
                    theme: localStorage.getItem('theme') || 'dark',
                    visiblePasswords: {}, // Track which passwords are visible
                    toastMessage: '',
                    toastType: '', // success, error, info
                    showGeneratedPassword: false, // Track visibility of generated password
                    searchQuery: '', // Search filter
                    passwordLength: 16, // Customizable password length
                    includeUppercase: true,
                    includeLowercase: true,
                    includeNumbers: true,
                    includeSymbols: true,
                    editingPasswordId: null, // Track which password is being edited
                    favorites: JSON.parse(localStorage.getItem('favorites') || '[]'), // Favorite passwords
                    selectedIds: [], // Bulk selection
                    recoveryCodes: [], // Generated recovery codes (one-time display)
                    showSettings: false, // Show password generator settings
                    enable2FA: false // Two-factor authentication flag
                    ,twoFAEnabled: false
                    ,show2FAModal: false
                    ,twoFAStage: 'idle' // idle | init | activate | verify
                    ,twoFASecret: ''
                    ,twoFAOtpAuth: ''
                    ,twoFATempToken: ''
                    ,twoFACode: ''
                    ,showDeleteConfirm: false
                    ,deleteTargetId: null
                    ,deleteTargetType: null // 'password' | 'user' | 'admin-password' | 'admin-user'
                    ,deleteTargetUserId: null // For admin password deletion
                    ,deletePromptTitle: ''
                    ,deletePromptText: ''
                    ,clientInfo: this.detectClient()
                    ,lastSaved: { website: '', username: '', password: '' }
                    ,editingOriginal: { website: '', username: '', password: '' }
                    ,adminView: 'dashboard' // dashboard | users | passwords | stats
                    ,adminUsers: []
                    ,adminStats: {}
                    ,adminPasswords: []
                    ,selectedUserId: null
                    ,selectedUserDetails: null
                };
                this.toastTimer = null;
                this.init();
            }

            detectClient() {
                const ua = navigator.userAgent;
                const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(ua);
                let platform = 'Unknown';
                let browser = 'Unknown';
                
                if (/Android/i.test(ua)) platform = 'Android';
                else if (/iPhone|iPad|iPod/i.test(ua)) platform = 'iOS';
                else if (/Windows/i.test(ua)) platform = 'Windows';
                else if (/Mac/i.test(ua)) platform = 'macOS';
                else if (/Linux/i.test(ua)) platform = 'Linux';
                
                if (/Chrome/i.test(ua) && !/Edg/i.test(ua)) browser = 'Chrome';
                else if (/Safari/i.test(ua) && !/Chrome/i.test(ua)) browser = 'Safari';
                else if (/Firefox/i.test(ua)) browser = 'Firefox';
                else if (/Edg/i.test(ua)) browser = 'Edge';
                
                // apply body class for client-specific CSS
                if (isMobile) { document.body.classList.add('client-mobile'); document.body.classList.remove('client-desktop'); }
                else { document.body.classList.add('client-desktop'); document.body.classList.remove('client-mobile'); }
                return { isMobile, platform, browser };
            }

            async init() {
                const savedToken = localStorage.getItem('token');
                const savedUser = localStorage.getItem('user');
                if (savedToken && savedUser) {
                    this.state.token = savedToken;
                    this.state.user = JSON.parse(savedUser);
                    this.state.screen = 'app';
                    await this.loadPasswords();
                    this.render();
                } else {
                    this.render();
                }
            }

            showToast(message, type = 'info') {
                // æ¸…é™¤ä¹‹å‰çš„å®šæ—¶å™¨å’ŒToast
                if (this.toastTimer) {
                    clearTimeout(this.toastTimer);
                    this.toastTimer = null;
                }
                
                const existingToast = document.getElementById('toast');
                if (existingToast) {
                    existingToast.remove();
                }
                
                // åˆ›å»ºæ–°Toast
                const toast = document.createElement('div');
                toast.id = 'toast';
                toast.className = `fixed top-4 right-4 px-6 py-3 rounded-lg shadow-2xl text-white font-bold z-50 transition-opacity duration-300 ${
                    type === 'success' ? 'bg-gradient-to-r from-green-600 to-emerald-600' :
                    type === 'error' ? 'bg-gradient-to-r from-red-600 to-pink-600' :
                    'bg-gradient-to-r from-blue-600 to-purple-600'
                }`;
                toast.textContent = message;
                toast.style.opacity = '1';
                document.body.appendChild(toast);
                
                // 3ç§’åæ·¡å‡ºå¹¶ç§»é™¤
                this.toastTimer = setTimeout(() => {
                    toast.style.opacity = '0';
                    setTimeout(() => {
                        if (toast.parentNode) {
                            toast.remove();
                        }
                    }, 300);
                    this.toastTimer = null;
                }, 3000);
            }

            async register() {
                if (!this.state.email || !this.state.password) {
                    this.showToast('Please fill in all fields', 'error');
                    return;
                }
                if (!this.validateEmail(this.state.email)) {
                    this.showToast('Invalid email format', 'error');
                    return;
                }
                if (!this.validatePasswordPolicy(this.state.password)) {
                    this.showToast('Password too weak (â‰¥8 & 3 types)', 'error');
                    return;
                }
                const token = await getTurnstileToken('register');
                try {
                    const res = await fetch(`${API_BASE}/api/auth/register`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json', 'X-CF-Turnstile': token },
                        body: JSON.stringify({ email: this.state.email, password: this.state.password })
                    });
                    if (res.ok) {
                        const data = await res.json();
                        this.state.token = data.token;
                        this.state.user = data.user;
                        localStorage.setItem('token', data.token);
                        localStorage.setItem('user', JSON.stringify(data.user));
                        this.state.screen = 'app';
                        this.state.email = '';
                        this.state.password = '';
                        await this.loadPasswords();
                        this.render();
                    } else {
                        const error = await res.json();
                        this.showToast('Registration failed: ' + error.error + (error['error-codes'] ? ' [' + error['error-codes'].join(',') + ']' : ''), 'error');
                    }
                } catch (e) {
                    this.showToast('Error: ' + e.message, 'error');
                }
            }

            async login() {
                // æ¸…ç†ä¸Šä¸€æ¬¡çš„æç¤ºï¼Œé¿å…é”™è¯¯æ¶ˆæ¯åœ¨æˆåŠŸç™»å½•åæ®‹ç•™
                this.state.toastMessage = '';
                if (!this.state.email || !this.state.password) {
                    this.showToast('Please fill in all fields', 'error');
                    return;
                }
                if (!this.validateEmail(this.state.email)) {
                    this.showToast('Invalid email format', 'error');
                    return;
                }
                const token = await getTurnstileToken('login');
                try {
                    const res = await fetch(`${API_BASE}/api/auth/login`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json', 'X-CF-Turnstile': token },
                        body: JSON.stringify({ email: this.state.email, password: this.state.password })
                    });
                    const data = await res.json();
                    if (res.ok && data.require2FA) {
                        // è¿›å…¥äºŒæ¬¡éªŒè¯é˜¶æ®µ
                        this.state.twoFAStage = 'verify';
                        this.state.twoFATempToken = data.tempToken;
                        this.state.show2FAModal = true;
                        this.render();
                        return;
                    }
                    if (res.ok && data.token) {
                        this.state.token = data.token;
                        this.state.user = data.user;
                        localStorage.setItem('token', data.token);
                        localStorage.setItem('user', JSON.stringify(data.user));
                        this.state.screen = 'app';
                        this.state.email = '';
                        this.state.password = '';
                        // æˆåŠŸåç¡®ä¿æ¸…é™¤ä»»ä½•é”™è¯¯æç¤º
                        this.state.toastMessage = '';
                        await this.loadPasswords();
                        this.render();
                    } else {
                        this.showToast('Login failed: ' + (data.error || 'Unknown'), 'error');
                    }
                } catch (e) {
                    this.showToast('Error: ' + e.message, 'error');
                }
            }

            logout() {
                this.state.user = null;
                this.state.token = null;
                this.state.passwords = [];
                this.state.screen = 'login';
                this.state.email = '';
                this.state.password = '';
                localStorage.removeItem('token');
                localStorage.removeItem('user');
                this.state.twoFAStage = 'idle';
                this.state.twoFATempToken = '';
                this.state.twoFASecret = '';
                this.render();
            }

            async loadPasswords() {
                try {
                    const res = await fetch(`${API_BASE}/api/passwords`, {
                        headers: { 'Authorization': `Bearer ${this.state.token}` }
                    });
                    if (res.ok) {
                        this.state.allPasswords = await res.json();
                        this.filterPasswords();
                        this.render();
                    }
                } catch (e) {
                    console.error('Failed to load passwords:', e);
                }
            }

            filterPasswords() {
                const query = this.state.searchQuery.toLowerCase();
                this.state.passwords = this.state.allPasswords.filter(p => 
                    p.website.toLowerCase().includes(query)
                );
            }

            searchPasswords(query) {
                this.state.searchQuery = query;
                this.filterPasswords();
                this.render();
            }

            calculatePasswordStrength(pwd) {
                let strength = 0;
                if (pwd.length >= 8) strength++;
                if (pwd.length >= 12) strength++;
                if (pwd.length >= 16) strength++;
                if (/[a-z]/.test(pwd)) strength++;
                if (/[A-Z]/.test(pwd)) strength++;
                if (/[0-9]/.test(pwd)) strength++;
                if (/[^a-zA-Z0-9]/.test(pwd)) strength++;
                
                if (strength <= 2) return { level: 'weak', color: 'red', text: 'Weak' };
                if (strength <= 5) return { level: 'medium', color: 'yellow', text: 'Medium' };
                return { level: 'strong', color: 'green', text: 'Strong' };
            }

            validateEmail(email) {
                return /^[^@\s]+@[^@\s]+\.[^@\s]+$/.test(email);
            }

            validatePasswordPolicy(pwd) {
                const categories = [/[a-z]/, /[A-Z]/, /[0-9]/, /[^a-zA-Z0-9]/].reduce((a,r)=> a + (r.test(pwd)?1:0),0);
                return pwd.length >= 8 && categories >= 3;
            }

            generatePassword() {
                let chars = '';
                if (this.state.includeUppercase) chars += 'ABCDEFGHIJKLMNOPQRSTUVWXYZ';
                if (this.state.includeLowercase) chars += 'abcdefghijklmnopqrstuvwxyz';
                if (this.state.includeNumbers) chars += '0123456789';
                if (this.state.includeSymbols) chars += '!@#$%^&*()_+-=[]{}|;:,.<>?';
                
                if (chars.length === 0) {
                    this.showToast('Please select at least one character type', 'error');
                    return;
                }
                
                let pwd = '';
                for (let i = 0; i < this.state.passwordLength; i++) {
                    pwd += chars.charAt(Math.floor(Math.random() * chars.length));
                }
                this.state.generatedPassword = pwd;
                this.state.showGeneratedPassword = false;
                this.render();
            }

            async savePassword() {
                const website = (this.state.newWebsite || '').trim();
                const password = (this.state.newPassword || '').trim();
                const username = (this.state.newUsername || '').trim();
                if (!website || !password) {
                    this.showToast('è¯·å¡«å†™ç½‘ç«™ä¸å¯†ç ', 'error');
                    return;
                }
                const last = this.state.lastSaved || { website: '', username: '', password: '' };
                if (last.website === website && last.username === username && last.password === password) {
                    this.showToast('æ— éœ€é‡å¤æ·»åŠ ', 'info');
                    return;
                }
                try {
                    const res = await fetch(`${API_BASE}/api/passwords`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${this.state.token}`
                        },
                        body: JSON.stringify({ website, username, tags: [], password })
                    });
                    if (res.ok) {
                        const data = await res.json();
                        if (data && data.id) {
                            this.state.lastSaved = { website, username, password };
                            this.state.newWebsite = '';
                            this.state.newUsername = '';
                            this.state.newPassword = '';
                            this.state.generatedPassword = '';
                            await this.loadPasswords();
                            this.render();
                            this.showToast('ä¿å­˜æˆåŠŸ âœ…', 'success');
                        } else {
                            this.showToast('ä¿å­˜å¤±è´¥ï¼šè¿”å›æ•°æ®å¼‚å¸¸', 'error');
                        }
                    } else {
                        const error = await res.json().catch(() => ({}));
                        this.showToast('ä¿å­˜å¤±è´¥: ' + (error.error || res.statusText || 'æœªçŸ¥é”™è¯¯'), 'error');
                    }
                } catch (e) {
                    this.showToast('ä¿å­˜é”™è¯¯: ' + e.message, 'error');
                }
            }

            async deletePassword(id) {
                this.state.showDeleteConfirm = true;
                this.state.deleteTargetId = id;
                this.render();
            }

            async confirmDelete() {
                try {
                    if (this.state.deleteTargetId) {
                        const id = this.state.deleteTargetId;
                        const res = await fetch(`${API_BASE}/api/passwords/${id}`, { method: 'DELETE', headers: { 'Authorization': `Bearer ${this.state.token}` } });
                        if (res.ok) { await this.loadPasswords(); this.showToast('åˆ é™¤æˆåŠŸ âœ…', 'success'); }
                        else { this.showToast('åˆ é™¤å¤±è´¥', 'error'); }
                    } else {
                        await Promise.all(this.state.selectedIds.map(id => fetch(`${API_BASE}/api/passwords/${id}`, { method:'DELETE', headers:{'Authorization':`Bearer ${this.state.token}`} })));
                        await this.loadPasswords();
                        this.clearSelection();
                        this.showToast('æ‰¹é‡åˆ é™¤å®Œæˆ âœ…', 'success');
                    }
                } catch (e) {
                    this.showToast('åˆ é™¤é”™è¯¯: ' + e.message, 'error');
                }
                this.state.showDeleteConfirm = false;
                this.state.deleteTargetId = null;
                this.render();
            }

            cancelDelete() {
                this.state.showDeleteConfirm = false;
                this.state.deleteTargetId = null;
                this.render();
            }

            startEditPassword(id, website, password, username = '') {
                this.state.editingPasswordId = id;
                this.state.newWebsite = website;
                this.state.newPassword = password;
                this.state.newUsername = username;
                this.state.editingOriginal = { website, username, password };
                this.render();
                setTimeout(() => {
                    document.getElementById('website')?.focus();
                }, 100);
            }

            async updatePassword() {
                const website = (this.state.newWebsite || '').trim();
                const password = (this.state.newPassword || '').trim();
                const username = (this.state.newUsername || '').trim();
                if (!website || !password) {
                    this.showToast('è¯·å¡«å†™ç½‘ç«™ä¸å¯†ç ', 'error');
                    return;
                }
                const original = this.state.editingOriginal || { website: '', username: '', password: '' };
                if (original.website === website && original.username === username && original.password === password) {
                    this.showToast('æœªæ”¹åŠ¨ï¼Œæ— éœ€ä¿å­˜', 'info');
                    return;
                }
                try {
                    const res = await fetch(`${API_BASE}/api/passwords/${this.state.editingPasswordId}`, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${this.state.token}`
                        },
                        body: JSON.stringify({ website, username, tags: [], password })
                    });
                    if (res.ok) {
                        this.state.newWebsite = '';
                        this.state.newUsername = '';
                        this.state.newPassword = '';
                        this.state.editingPasswordId = null;
                        this.state.editingOriginal = null;
                        await this.loadPasswords();
                        this.render();
                        this.showToast('å·²æ›´æ–° âœï¸', 'success');
                    } else {
                        this.showToast('æ›´æ–°å¤±è´¥', 'error');
                    }
                } catch (e) {
                    this.showToast('æ›´æ–°é”™è¯¯: ' + e.message, 'error');
                }
            }

            cancelEdit() {
                this.state.editingPasswordId = null;
                this.state.newWebsite = '';
                this.state.newUsername = '';
                this.state.newPassword = '';
                this.state.editingOriginal = null;
                this.render();
            }

            toggleFavorite(id) {
                const index = this.state.favorites.indexOf(id);
                if (index > -1) {
                    this.state.favorites.splice(index, 1);
                } else {
                    this.state.favorites.push(id);
                }
                localStorage.setItem('favorites', JSON.stringify(this.state.favorites));
                this.render();
            }

            toggleSelect(id) {
                const idx = this.state.selectedIds.indexOf(id);
                if (idx > -1) this.state.selectedIds.splice(idx,1); else this.state.selectedIds.push(id);
                this.render();
            }

            clearSelection() {
                this.state.selectedIds = [];
                this.render();
            }

            bulkDelete() {
                if (this.state.selectedIds.length === 0) return;
                this.state.showDeleteConfirm = true;
                this.state.deleteTargetId = null;
                this.state.deletePromptTitle = 'ç¡®è®¤æ‰¹é‡åˆ é™¤';
                this.state.deletePromptText = `å°†åˆ é™¤é€‰ä¸­çš„ ${this.state.selectedIds.length} æ¡å¯†ç ã€‚è¯¥æ“ä½œä¸å¯æ¢å¤ã€‚`;
                this.render();
            }

            bulkExport() {
                if (this.state.selectedIds.length === 0) return;
                const subset = this.state.allPasswords.filter(p=> this.state.selectedIds.includes(p.id)).map(p=> ({
                    id: p.id,
                    website: p.website,
                    username: p.username || '',
                    password: p.password,
                    created_at: p.created_at
                }));
                const data = JSON.stringify(subset, null, 2);
                const blob = new Blob([data], { type:'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `passwords-selected-${new Date().toISOString().split('T')[0]}.json`;
                a.click();
                URL.revokeObjectURL(url);
                this.showToast('å·²å¯¼å‡ºé€‰ä¸­é¡¹ ğŸ“¦','success');
            }

            async generateRecoveryCodes() {
                try {
                    const res = await fetch(`${API_BASE}/api/auth/2fa/recovery/generate`, { method:'POST', headers:{'Authorization':`Bearer ${this.state.token}`} })
                    const data = await res.json()
                    if (res.ok) {
                        this.state.recoveryCodes = data.codes;
                        this.showToast('æ¢å¤ç å·²ç”Ÿæˆ','success');
                        this.render();
                        // æ·»åŠ æç¤ºç”¨æˆ·ä¿å­˜æ¢å¤ç çš„å¯¹è¯æ¡†
                        this.showRecoveryCodesModal();
                    } else {
                        this.showToast('ç”Ÿæˆå¤±è´¥: '+(data.error||'é”™è¯¯'),'error');
                    }
                } catch(e){
                    this.showToast('ç”Ÿæˆå¤±è´¥: '+e.message,'error');
                }
            }

            showRecoveryCodesModal() {
                // åˆ›å»ºä¸€ä¸ªæ¨¡æ€æ¡†æ˜¾ç¤ºæ¢å¤ç å¹¶æç¤ºç”¨æˆ·ä¿å­˜
                const modal = document.createElement('div');
                modal.className = 'fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center z-50';
                modal.innerHTML = `
                    <div class='bg-[#0F1E2E] border border-[#F48120] rounded-xl p-6 w-[90%] max-w-md shadow-2xl animate-slideIn'>
                        <h3 class='text-xl font-bold text-white mb-4'>é‡è¦ï¼šè¯·ä¿å­˜æ‚¨çš„æ¢å¤ç </h3>
                        <p class='text-sm text-gray-300 mb-4'>
                            è¿™äº›æ¢å¤ç æ˜¯æ‚¨åœ¨æ— æ³•è®¿é—®äºŒæ¬¡éªŒè¯è®¾å¤‡æ—¶çš„å”¯ä¸€å‡­è¯ï¼Œè¯·å¦¥å–„ä¿ç®¡ã€‚
                        </p>
                        <div class='bg-slate-800 rounded-lg p-4 mb-4'>
                            <ul class='grid grid-cols-2 gap-2'>
                                ${this.state.recoveryCodes.map(code => `<li class='text-center py-2 px-3 bg-slate-700 rounded font-mono text-white'>${code}</li>`).join('')}
                            </ul>
                        </div>
                        <p class='text-yellow-400 text-sm mb-4'>
                            âš ï¸ æ³¨æ„ï¼šè¿™äº›æ¢å¤ç åªæ˜¾ç¤ºä¸€æ¬¡ï¼Œè¯·ç«‹å³ä¿å­˜ï¼ä¸€æ—¦å…³é—­æ­¤çª—å£å°†æ— æ³•å†æ¬¡æŸ¥çœ‹ã€‚
                        </p>
                        <div class='flex gap-2'>
                            <button onclick='manager.copyRecoveryCodes()' class='flex-1 bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 rounded'>
                                å¤åˆ¶å…¨éƒ¨
                            </button>
                            <button onclick='manager.downloadRecoveryCodes()' class='flex-1 bg-green-600 hover:bg-green-700 text-white font-bold py-2 rounded'>
                                ä¸‹è½½ TXT
                            </button>
                            <button onclick='this.closest(".fixed").remove()' class='flex-1 bg-slate-600 hover:bg-slate-500 text-white font-bold py-2 rounded'>
                                å…³é—­
                            </button>
                        </div>
                    </div>
                `;
                document.body.appendChild(modal);
            }

            copyRecoveryCodes() {
                const codesText = this.state.recoveryCodes.join('\n');
                navigator.clipboard.writeText(codesText).then(() => {
                    this.showToast('æ¢å¤ç å·²å¤åˆ¶åˆ°å‰ªè´´æ¿', 'success');
                }).catch(err => {
                    this.showToast('å¤åˆ¶å¤±è´¥: ' + err, 'error');
                });
            }

            downloadRecoveryCodes() {
                const codesText = `PassFortress æ¢å¤ç \n\nè¯·å¦¥å–„ä¿ç®¡è¿™äº›æ¢å¤ç ï¼Œå®ƒä»¬æ˜¯æ‚¨åœ¨æ— æ³•è®¿é—®äºŒæ¬¡éªŒè¯è®¾å¤‡æ—¶çš„å”¯ä¸€å‡­è¯ã€‚\n\n${this.state.recoveryCodes.join('\n')}\n\nç”Ÿæˆæ—¶é—´: ${new Date().toLocaleString()}`;
                const blob = new Blob([codesText], { type: 'text/plain;charset=utf-8' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `passfortress-recovery-codes-${new Date().toISOString().slice(0, 10)}.txt`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                this.showToast('æ¢å¤ç æ–‡ä»¶å·²ä¸‹è½½', 'success');
            }

            async verifyRecoveryCode() {
                if (!this.state.twoFATempToken || !this.state.twoFACode) { this.showToast('è¯·è¾“å…¥æ¢å¤ç ','error'); return; }
                // ç¡®ä¿æ¢å¤ç è½¬æ¢ä¸ºå¤§å†™å½¢å¼å†å‘é€åˆ°æœåŠ¡å™¨
                const recoveryCode = this.state.twoFACode.toUpperCase();
                try {
                    const res = await fetch(`${API_BASE}/api/auth/2fa/recovery/verify`, { 
                        method:'POST', 
                        headers:{'Content-Type':'application/json'}, 
                        body: JSON.stringify({ 
                            tempToken: this.state.twoFATempToken, 
                            recoveryCode: recoveryCode
                        }) 
                    })
                    const data = await res.json();
                    if (res.ok && data.token) {
                        this.state.token = data.token;
                        this.state.user = data.user;
                        localStorage.setItem('token', data.token);
                        localStorage.setItem('user', JSON.stringify(data.user));
                        this.state.screen = 'app';
                        this.state.twoFAStage = 'idle';
                        this.state.twoFATempToken = '';
                        this.state.twoFACode = '';
                        await this.loadPasswords();
                        this.showToast('æ¢å¤ç éªŒè¯æˆåŠŸ âœ…','success');
                        this.render();
                    } else {
                        this.showToast('æ¢å¤ç æ— æ•ˆ','error');
                    }
                } catch(e){
                    this.showToast('éªŒè¯å¤±è´¥: '+e.message,'error');
                }
            }

            exportPasswords() {
                const enriched = this.state.allPasswords.map(p => ({
                    id: p.id,
                    website: p.website,
                    username: p.username || '',
                    password: p.password,
                    created_at: p.created_at
                }));
                const data = JSON.stringify(enriched, null, 2);
                const blob = new Blob([data], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `passwords-backup-${new Date().toISOString().split('T')[0]}.json`;
                a.click();
                URL.revokeObjectURL(url);
                this.showToast('å·²å¯¼å‡º ğŸ“¦', 'success');
            }

            importPasswords() {
                const input = document.createElement('input');
                input.type = 'file';
                input.accept = 'application/json';
                input.onchange = async (e) => {
                    try {
                        const file = e.target.files[0];
                        const text = await file.text();
                        const imported = JSON.parse(text);
                        
                        for (const pwd of imported) {
                            await fetch(`${API_BASE}/api/passwords`, {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json',
                                    'Authorization': `Bearer ${this.state.token}`
                                },
                                body: JSON.stringify({ website: pwd.website, username: pwd.username || '', tags: [], password: pwd.password })
                            });
                        }
                        
                        await this.loadPasswords();
                        this.showToast(`å¯¼å…¥ ${imported.length} æ¡å¯†ç  ğŸ“¥`, 'success');
                    } catch (e) {
                        this.showToast('å¯¼å…¥å¤±è´¥: ' + e.message, 'error');
                    }
                };
                input.click();
            }

            toggleTheme() {
                this.state.theme = this.state.theme === 'dark' ? 'light' : 'dark';
                localStorage.setItem('theme', this.state.theme);
                document.body.className = this.state.theme === 'light' ? 'bg-gray-100 text-gray-900' : 'text-gray-200';
                this.render();
            }

            getPasswordAge(createdAt) {
                const days = Math.floor((Date.now() - new Date(createdAt)) / (1000 * 60 * 60 * 24));
                if (days > 90) return { text: `${days} days old`, color: 'red', warning: true };
                if (days > 60) return { text: `${days} days old`, color: 'yellow', warning: true };
                return { text: `${days} days old`, color: 'green', warning: false };
            }

            copyToClipboard(text) {
                navigator.clipboard.writeText(text).then(() => {
                    this.showToast('Copied to clipboard! ğŸ“‹', 'success');
                });
            }

            togglePasswordVisibility(id) {
                this.state.visiblePasswords[id] = !this.state.visiblePasswords[id];
                this.render();
            }

            toggleGeneratedPasswordVisibility() {
                this.state.showGeneratedPassword = !this.state.showGeneratedPassword;
                this.render();
            }

            useGeneratedPassword() {
                this.state.newPassword = this.state.generatedPassword;
                this.copyToClipboard(this.state.generatedPassword);
                this.render();
                // Auto-focus on website input after using generated password
                setTimeout(() => {
                    const websiteInput = document.getElementById('website');
                    if (websiteInput && !this.state.newWebsite) {
                        websiteInput.focus();
                    }
                }, 100);
            }

            toggleTheme() {
                this.state.theme = this.state.theme === 'dark' ? 'light' : 'dark';
                localStorage.setItem('theme', this.state.theme);
                this.render();
            }

            // ==================== Admin Methods ====================
            
            isAdmin() {
                return this.state.user && this.state.user.is_admin === 1;
            }

            async loadAdminStats() {
                if (!this.isAdmin()) return;
                try {
                    const res = await fetch(`${API_BASE}/api/admin/stats`, {
                        headers: { 'Authorization': `Bearer ${this.state.token}` }
                    });
                    if (res.ok) {
                        this.state.adminStats = await res.json();
                    }
                } catch (e) {
                    this.showToast('åŠ è½½ç»Ÿè®¡å¤±è´¥', 'error');
                }
            }

            async loadAdminUsers() {
                if (!this.isAdmin()) return;
                try {
                    const res = await fetch(`${API_BASE}/api/admin/users`, {
                        headers: { 'Authorization': `Bearer ${this.state.token}` }
                    });
                    if (res.ok) {
                        this.state.adminUsers = await res.json();
                    }
                } catch (e) {
                    this.showToast('åŠ è½½ç”¨æˆ·å¤±è´¥', 'error');
                }
            }

            async loadAdminPasswords() {
                if (!this.isAdmin()) return;
                try {
                    const res = await fetch(`${API_BASE}/api/admin/passwords`, {
                        headers: { 'Authorization': `Bearer ${this.state.token}` }
                    });
                    if (res.ok) {
                        this.state.adminPasswords = await res.json();
                    }
                } catch (e) {
                    this.showToast('åŠ è½½æ‰€æœ‰å¯†ç å¤±è´¥', 'error');
                }
            }

            async viewUserDetails(userId) {
                if (!this.isAdmin()) return;
                try {
                    const res = await fetch(`${API_BASE}/api/admin/users/${userId}`, {
                        headers: { 'Authorization': `Bearer ${this.state.token}` }
                    });
                    if (res.ok) {
                        this.state.selectedUserDetails = await res.json();
                        this.state.selectedUserId = userId;
                        this.render();
                    }
                } catch (e) {
                    this.showToast('åŠ è½½ç”¨æˆ·è¯¦æƒ…å¤±è´¥', 'error');
                }
            }

            deleteUser(userId) {
                if (!this.isAdmin()) return;
                this.state.deleteTargetId = userId;
                this.state.deleteTargetType = 'admin-user';
                this.state.deletePromptTitle = 'âš ï¸ å±é™©æ“ä½œ';
                this.state.deletePromptText = 'è¯¥æ“ä½œå°†æ°¸ä¹…åˆ é™¤è¯¥ç”¨æˆ·åŠå…¶æ‰€æœ‰å¯†ç æ•°æ®ï¼Œä¸”æ— æ³•æ¢å¤ï¼';
                this.state.showDeleteConfirm = true;
                this.render();
            }

            async executeDeleteUser() {
                try {
                    const res = await fetch(`${API_BASE}/api/admin/users/${this.state.deleteTargetId}`, {
                        method: 'DELETE',
                        headers: { 'Authorization': `Bearer ${this.state.token}` }
                    });
                    if (res.ok) {
                        this.showToast('ç”¨æˆ·å·²åˆ é™¤', 'success');
                        this.state.selectedUserId = null;
                        this.state.selectedUserDetails = null;
                        await this.loadAdminUsers();
                        this.render();
                    } else {
                        const error = await res.json();
                        this.showToast('åˆ é™¤å¤±è´¥: ' + error.message, 'error');
                    }
                } catch (e) {
                    this.showToast('åˆ é™¤ç”¨æˆ·å¤±è´¥', 'error');
                }
            }

            async toggleUserAdmin(userId, currentStatus) {
                if (!this.isAdmin()) return;
                try {
                    const res = await fetch(`${API_BASE}/api/admin/users/${userId}/admin`, {
                        method: 'PATCH',
                        headers: { 
                            'Authorization': `Bearer ${this.state.token}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ is_admin: currentStatus === 1 ? 0 : 1 })
                    });
                    if (res.ok) {
                        this.showToast('ç®¡ç†å‘˜æƒé™å·²æ›´æ–°', 'success');
                        await this.loadAdminUsers();
                        this.render();
                    } else {
                        const error = await res.json();
                        this.showToast('æ›´æ–°å¤±è´¥: ' + error.message, 'error');
                    }
                } catch (e) {
                    this.showToast('æ›´æ–°å¤±è´¥', 'error');
                }
            }

            deletePasswordAsAdmin(passwordId, userId) {
                if (!this.isAdmin()) return;
                this.state.deleteTargetId = passwordId;
                this.state.deleteTargetUserId = userId;
                this.state.deleteTargetType = 'admin-password';
                this.state.deletePromptTitle = 'ç¡®è®¤åˆ é™¤';
                this.state.deletePromptText = 'è¯¥æ“ä½œå°†æ°¸ä¹…åˆ é™¤è¯¥å¯†ç æ¡ç›®ï¼Œä¸”æ— æ³•æ¢å¤ã€‚';
                this.state.showDeleteConfirm = true;
                this.render();
            }

            async executeDeletePasswordAsAdmin() {
                try {
                    const res = await fetch(`${API_BASE}/api/admin/passwords/${this.state.deleteTargetId}`, {
                        method: 'DELETE',
                        headers: { 'Authorization': `Bearer ${this.state.token}` }
                    });
                    if (res.ok) {
                        this.showToast('å¯†ç å·²åˆ é™¤', 'success');
                        // å¦‚æœåœ¨ç”¨æˆ·è¯¦æƒ…é¡µï¼Œé‡æ–°åŠ è½½ç”¨æˆ·è¯¦æƒ…
                        if (this.state.selectedUserId) {
                            await this.viewUserDetails(this.state.deleteTargetUserId);
                        } else {
                            await this.loadAdminPasswords();
                            this.render();
                        }
                    } else {
                        const error = await res.json();
                        this.showToast('åˆ é™¤å¤±è´¥: ' + error.message, 'error');
                    }
                } catch (e) {
                    this.showToast('åˆ é™¤å¯†ç å¤±è´¥', 'error');
                }
            }

            closeUserDetails() {
                this.state.selectedUserId = null;
                this.state.selectedUserDetails = null;
                this.render();
            }

            switchAdminView(view) {
                this.state.adminView = view;
                this.state.selectedUserId = null;
                this.state.selectedUserDetails = null;
                
                if (view === 'dashboard') {
                    this.loadAdminStats();
                } else if (view === 'users') {
                    this.loadAdminUsers();
                } else if (view === 'passwords') {
                    this.loadAdminPasswords();
                }
                this.render();
            }

            deleteUser(userId) {
                if (!this.isAdmin()) return;
                this.state.deleteTargetId = userId;
                this.state.deleteTargetType = 'admin-user';
                this.state.deletePromptTitle = 'âš ï¸ å±é™©æ“ä½œ';
                this.state.deletePromptText = 'è¯¥æ“ä½œå°†æ°¸ä¹…åˆ é™¤è¯¥ç”¨æˆ·åŠå…¶æ‰€æœ‰å¯†ç æ•°æ®ï¼Œä¸”æ— æ³•æ¢å¤ï¼';
                this.state.showDeleteConfirm = true;
                this.render();
            }

            async executeDeleteUser() {
                try {
                    const res = await fetch(`${API_BASE}/api/admin/users/${this.state.deleteTargetId}`, {
                        method: 'DELETE',
                        headers: { 'Authorization': `Bearer ${this.state.token}` }
                    });
                    if (res.ok) {
                        this.showToast('ç”¨æˆ·å·²åˆ é™¤', 'success');
                        this.state.selectedUserId = null;
                        this.state.selectedUserDetails = null;
                        await this.loadAdminUsers();
                        this.render();
                    } else {
                        const error = await res.json();
                        this.showToast('åˆ é™¤å¤±è´¥: ' + error.message, 'error');
                    }
                } catch (e) {
                    this.showToast('åˆ é™¤ç”¨æˆ·å¤±è´¥', 'error');
                }
            }

            async confirmDelete() {
                this.state.showDeleteConfirm = false;
                const targetType = this.state.deleteTargetType;
                
                if (targetType === 'password') {
                    await this.executeDeletePassword();
                } else if (targetType === 'admin-password') {
                    await this.executeDeletePasswordAsAdmin();
                } else if (targetType === 'user') {
                    await this.executeDeleteUserPassword();
                } else if (targetType === 'admin-user') {
                    await this.executeDeleteUser();
                }
                
                this.state.deleteTargetId = null;
                this.state.deleteTargetUserId = null;
                this.state.deleteTargetType = null;
                this.render();
            }

            cancelDelete() {
                this.state.showDeleteConfirm = false;
                this.state.deleteTargetId = null;
                this.state.deleteTargetUserId = null;
                this.state.deleteTargetType = null;
                this.render();
            }


            render() {
                const app = document.getElementById('app');
                
                if (this.state.screen === 'login') {
                    app.innerHTML = this.renderLoginScreen();
                } else if (this.state.screen === 'register') {
                    app.innerHTML = this.renderRegisterScreen();
                } else if (this.state.screen === 'admin') {
                    app.innerHTML = this.renderAdminScreen();
                } else {
                    app.innerHTML = this.renderAppScreen();
                }
                
                // Unified Delete confirmation modal
                const existingModal = document.getElementById('delete-modal');
                if (existingModal) existingModal.remove();
                if (this.state.showDeleteConfirm) {
                    const modal = document.createElement('div');
                    modal.id = 'delete-modal';
                    modal.className = 'fixed inset-0 flex items-center justify-center z-50';
                    modal.innerHTML = `
                        <div class="absolute inset-0 bg-black/60 backdrop-blur-sm"></div>
                        <div class="relative bg-[#0F1E2E] border border-[#F48120] rounded-xl p-6 w-[360px] shadow-2xl animate-slideIn">
                            <h3 class="text-xl font-bold text-white mb-2">${this.state.deletePromptTitle || 'ç¡®è®¤åˆ é™¤'}</h3>
                            <p class="text-sm text-gray-300 mb-4">${this.state.deletePromptText || 'è¯¥æ“ä½œå°†æ°¸ä¹…ç§»é™¤è¯¥å¯†ç æ¡ç›®ã€‚'}</p>
                            <div class="flex gap-3">
                                <button onclick="manager.confirmDelete()" class="btn-hover flex-1 bg-gradient-to-r from-red-600 to-orange-600 text-white font-bold py-2 rounded-lg transition">åˆ é™¤</button>
                                <button onclick="manager.cancelDelete()" class="btn-hover flex-1 bg-slate-600 text-white font-bold py-2 rounded-lg transition">å–æ¶ˆ</button>
                            </div>
                        </div>`;
                    document.body.appendChild(modal);
                }
                                // 2FA æ¨¡æ€
                                const existing2FA = document.getElementById('twofa-modal');
                                if (existing2FA) existing2FA.remove();
                                if (this.state.show2FAModal) {
                                        const modal = document.createElement('div');
                                        modal.id = 'twofa-modal';
                                        modal.className = 'fixed inset-0 flex items-center justify-center z-50';
                                        let bodyHTML = '';
                                        if (this.state.twoFAStage === 'init') {
                                                bodyHTML = `
                                                    <p class='text-sm text-gray-300 mb-3'>ä½¿ç”¨ <strong class='text-[#F48120]'>Google Authenticator</strong> æˆ–å…¶ä»–èº«ä»½éªŒè¯ App æ‰«æäºŒç»´ç ï¼š</p>
                                                    <div id='qrcode' class='flex justify-center mb-3'></div>
                                                    <p class='text-xs text-gray-400 text-center mb-2'>æˆ–æ‰‹åŠ¨è¾“å…¥å¯†é’¥ï¼š</p>
                                                    <div class='p-3 rounded bg-slate-700 font-mono break-all text-xs mb-3 select-all'>${this.state.twoFASecret}</div>
                                                    <input type='text' placeholder='6ä½éªŒè¯ç ' class='w-full bg-slate-700 text-white p-2 rounded mb-3 text-center tracking-widest' oninput='manager.state.twoFACode = this.value' />
                                                    <div class='flex gap-2'>
                                                        <button onclick='manager.activate2FA()' class='flex-1 bg-green-600 hover:bg-green-700 text-white font-bold py-2 rounded'>ç¡®è®¤å¯ç”¨</button>
                                                        <button onclick='manager.close2FAModal()' class='flex-1 bg-slate-600 hover:bg-slate-500 text-white font-bold py-2 rounded'>å–æ¶ˆ</button>
                                                    </div>`;
                                        } else if (this.state.twoFAStage === 'verify') {
                                                bodyHTML = `
                                                    <p class='text-sm text-gray-300 mb-4'>è¾“å…¥åŠ¨æ€éªŒè¯ç æˆ–ä½¿ç”¨æ¢å¤ç ã€‚</p>
                                                    <div class='space-y-3'>
                                                        <input type='text' placeholder='åŠ¨æ€éªŒè¯ç  (6ä½)' class='w-full bg-slate-700 text-white p-2 rounded text-center tracking-widest' oninput='manager.state.twoFACode = this.value' />
                                                        <button onclick='manager.verifyLogin2FA()' class='w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 rounded'>ä½¿ç”¨åŠ¨æ€éªŒè¯ç </button>
                                                        <div class='border-t border-slate-600 pt-3'>
                                                            <input type='text' placeholder='æ¢å¤ç  (ä¸åŒºåˆ†å¤§å°å†™)' class='w-full bg-slate-700 text-white p-2 rounded text-center' oninput='manager.state.twoFACode = this.value' />
                                                            <button onclick='manager.verifyRecoveryCode()' class='w-full mt-2 bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 rounded'>ä½¿ç”¨æ¢å¤ç </button>
                                                        </div>
                                                        <button onclick='manager.close2FAModal()' class='w-full bg-slate-600 hover:bg-slate-500 text-white font-bold py-2 rounded'>å–æ¶ˆ</button>
                                                    </div>`;
                                        } else if (this.state.twoFAStage === 'disable') {
                                                bodyHTML = `
                                                    <p class='text-sm text-gray-300 mb-3'>è¾“å…¥å½“å‰éªŒè¯ç ä»¥å…³é—­äºŒæ¬¡éªŒè¯ã€‚</p>
                                                    <input type='text' placeholder='6ä½éªŒè¯ç ' class='w-full bg-slate-700 text-white p-2 rounded mb-3 text-center tracking-widest' oninput='manager.state.twoFACode = this.value' />
                                                    <div class='flex gap-2'>
                                                        <button onclick='manager.disable2FA()' class='flex-1 bg-red-600 hover:bg-red-700 text-white font-bold py-2 rounded'>å…³é—­</button>
                                                        <button onclick='manager.close2FAModal()' class='flex-1 bg-slate-600 hover:bg-slate-500 text-white font-bold py-2 rounded'>å–æ¶ˆ</button>
                                                    </div>`;
                                        }
                                        modal.innerHTML = `
                                            <div class='absolute inset-0 bg-black/60 backdrop-blur-sm'></div>
                                            <div class='relative bg-[#0F1E2E] border border-[#F48120] rounded-xl p-6 w-[360px] shadow-2xl animate-slideIn'>
                                                <h3 class='text-xl font-bold text-white mb-4'>äºŒæ¬¡éªŒè¯ ${this.state.twoFAStage==='verify'?'ç™»å½•':'è®¾ç½®'}</h3>
                                                ${bodyHTML}
                                            </div>`;
                                        document.body.appendChild(modal);
                                        if (this.state.twoFAStage === 'init') setTimeout(()=> this.generateQR(),50);
                                }
            }

            renderAdminScreen() {
                return `
                    <div class="min-h-screen bg-gradient-to-br from-[#0F1E2E] via-slate-900 to-[#0F1E2E] p-4">
                        <div class="max-w-6xl mx-auto">
                            <!-- Header -->
                            <div class="flex justify-between items-center mb-6">
                                <div>
                                    <h1 class="text-4xl font-bold text-white mb-1">ğŸ‘‘ ç®¡ç†å‘˜é¢æ¿</h1>
                                    <p class="text-gray-400 text-sm">æ¬¢è¿ï¼Œç®¡ç†å‘˜ <span class="text-[#F48120]">${this.state.user.email}</span></p>
                                </div>
                                <div class="flex gap-2">
                                    <button onclick="manager.state.screen='app'; manager.render()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg transition">
                                        ğŸ”™ è¿”å›ç”¨æˆ·ç•Œé¢
                                    </button>
                                    <button onclick="manager.logout()" class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-lg transition">
                                        ğŸšª é€€å‡º
                                    </button>
                                </div>
                            </div>

                            <!-- Navigation Tabs -->
                            <div class="flex gap-2 mb-6 border-b border-gray-700">
                                <button onclick="manager.switchAdminView('dashboard')" class="px-6 py-3 font-semibold ${this.state.adminView === 'dashboard' ? 'text-[#F48120] border-b-2 border-[#F48120]' : 'text-gray-400 hover:text-gray-200'}">
                                    ğŸ“Š ä»ªè¡¨æ¿
                                </button>
                                <button onclick="manager.switchAdminView('users')" class="px-6 py-3 font-semibold ${this.state.adminView === 'users' ? 'text-[#F48120] border-b-2 border-[#F48120]' : 'text-gray-400 hover:text-gray-200'}">
                                    ğŸ‘¥ ç”¨æˆ·ç®¡ç†
                                </button>
                                <button onclick="manager.switchAdminView('passwords')" class="px-6 py-3 font-semibold ${this.state.adminView === 'passwords' ? 'text-[#F48120] border-b-2 border-[#F48120]' : 'text-gray-400 hover:text-gray-200'}">
                                    ğŸ”‘ å¯†ç æ€»è§ˆ
                                </button>
                            </div>

                            <!-- Content Area -->
                            ${this.state.adminView === 'dashboard' ? this.renderAdminDashboard() : ''}
                            ${this.state.adminView === 'users' ? this.renderAdminUsers() : ''}
                            ${this.state.adminView === 'passwords' ? this.renderAdminPasswords() : ''}
                        </div>
                    </div>
                `;
            }

            renderAdminDashboard() {
                const stats = this.state.adminStats;
                return `
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                        <div class="bg-gradient-to-br from-blue-600 to-blue-800 rounded-lg p-4 shadow-xl">
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="text-blue-200 text-sm font-medium">æ€»ç”¨æˆ·æ•°</p>
                                    <p class="text-white text-3xl font-bold mt-1">${stats.total_users || 0}</p>
                                </div>
                                <div class="text-4xl">ğŸ‘¥</div>
                            </div>
                        </div>
                        <div class="bg-gradient-to-br from-purple-600 to-purple-800 rounded-lg p-4 shadow-xl">
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="text-purple-200 text-sm font-medium">ç®¡ç†å‘˜æ•°</p>
                                    <p class="text-white text-3xl font-bold mt-1">${stats.total_admins || 0}</p>
                                </div>
                                <div class="text-4xl">ğŸ‘‘</div>
                            </div>
                        </div>
                        <div class="bg-gradient-to-br from-green-600 to-green-800 rounded-lg p-4 shadow-xl">
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="text-green-200 text-sm font-medium">æ€»å¯†ç æ•°</p>
                                    <p class="text-white text-3xl font-bold mt-1">${stats.total_passwords || 0}</p>
                                </div>
                                <div class="text-4xl">ğŸ”‘</div>
                            </div>
                        </div>
                        <div class="bg-gradient-to-br from-orange-600 to-orange-800 rounded-lg p-4 shadow-xl">
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="text-orange-200 text-sm font-medium">å¯ç”¨2FAç”¨æˆ·</p>
                                    <p class="text-white text-3xl font-bold mt-1">${stats.users_with_2fa || 0}</p>
                                </div>
                                <div class="text-4xl">ğŸ”’</div>
                            </div>
                        </div>
                    </div>
                    <div class="mt-4 bg-slate-800 border border-purple-500 rounded-lg p-4">
                        <h2 class="text-xl font-bold text-white mb-3">ğŸ“ˆ ç³»ç»Ÿæ¦‚è§ˆ</h2>
                        <div class="space-y-2 text-gray-300 text-sm">
                            <p>â€¢ å¹³å‡æ¯ç”¨æˆ·å¯†ç æ•°: <span class="text-[#F48120] font-bold">${stats.total_users > 0 ? (stats.total_passwords / stats.total_users).toFixed(1) : 0}</span></p>
                            <p>â€¢ 2FA å¯ç”¨ç‡: <span class="text-[#F48120] font-bold">${stats.total_users > 0 ? ((stats.users_with_2fa / stats.total_users) * 100).toFixed(1) : 0}%</span></p>
                            <p>â€¢ ç³»ç»ŸçŠ¶æ€: <span class="text-green-400 font-bold">âœ… æ­£å¸¸è¿è¡Œ</span></p>
                        </div>
                    </div>
                `;
            }

            renderAdminUsers() {
                if (this.state.selectedUserId && this.state.selectedUserDetails) {
                    return this.renderUserDetails();
                }

                return `
                    <div class="bg-slate-800 border border-purple-500 rounded-lg p-6 shadow-xl">
                        <h2 class="text-2xl font-bold text-white mb-6">ğŸ‘¥ ç”¨æˆ·åˆ—è¡¨ (${this.state.adminUsers.length})</h2>
                        <div class="overflow-x-auto">
                            <table class="w-full">
                                <thead>
                                    <tr class="border-b border-gray-700">
                                        <th class="text-left py-3 px-4 text-gray-400 font-semibold">ID</th>
                                        <th class="text-left py-3 px-4 text-gray-400 font-semibold">é‚®ç®±</th>
                                        <th class="text-left py-3 px-4 text-gray-400 font-semibold">è§’è‰²</th>
                                        <th class="text-left py-3 px-4 text-gray-400 font-semibold">2FA</th>
                                        <th class="text-left py-3 px-4 text-gray-400 font-semibold">å¯†ç æ•°</th>
                                        <th class="text-left py-3 px-4 text-gray-400 font-semibold">æ³¨å†Œæ—¶é—´</th>
                                        <th class="text-left py-3 px-4 text-gray-400 font-semibold">æ“ä½œ</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${this.state.adminUsers.map(user => `
                                        <tr class="border-b border-gray-700 hover:bg-slate-700 transition">
                                            <td class="py-3 px-4 text-white">${user.id}</td>
                                            <td class="py-3 px-4 text-white font-mono text-sm">${user.email}</td>
                                            <td class="py-3 px-4">
                                                <span class="px-2 py-1 rounded text-xs font-bold ${user.is_admin ? 'bg-orange-600 text-white' : 'bg-gray-600 text-gray-200'}">
                                                    ${user.is_admin ? 'ğŸ‘‘ ç®¡ç†å‘˜' : 'ğŸ‘¤ ç”¨æˆ·'}
                                                </span>
                                            </td>
                                            <td class="py-3 px-4">${user.two_factor_enabled ? 'âœ…' : 'âŒ'}</td>
                                            <td class="py-3 px-4 text-white">${user.password_count || 0}</td>
                                            <td class="py-3 px-4 text-gray-400 text-sm">${new Date(user.created_at).toLocaleDateString()}</td>
                                            <td class="py-3 px-4">
                                                <div class="flex gap-2">
                                                    <button onclick="manager.viewUserDetails(${user.id})" class="bg-blue-600 hover:bg-blue-700 text-white px-3 py-1 rounded text-sm" title="æŸ¥çœ‹è¯¦æƒ…">
                                                        ğŸ‘ï¸
                                                    </button>
                                                    <button onclick="manager.toggleUserAdmin(${user.id}, ${user.is_admin})" class="bg-purple-600 hover:bg-purple-700 text-white px-3 py-1 rounded text-sm" title="${user.is_admin ? 'æ’¤é”€ç®¡ç†å‘˜' : 'è®¾ä¸ºç®¡ç†å‘˜'}">
                                                        ${user.is_admin ? 'ğŸ‘¤' : 'ğŸ‘‘'}
                                                    </button>
                                                    <button onclick="manager.deleteUser(${user.id})" class="bg-red-600 hover:bg-red-700 text-white px-3 py-1 rounded text-sm" title="åˆ é™¤ç”¨æˆ·" ${user.id === this.state.user.id ? 'disabled style="opacity:0.5;cursor:not-allowed;"' : ''}>
                                                        ğŸ—‘ï¸
                                                    </button>
                                                </div>
                                            </td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    </div>
                `;
            }

            renderUserDetails() {
                const { user, passwords } = this.state.selectedUserDetails;
                return `
                    <div class="space-y-6">
                        <button onclick="manager.closeUserDetails()" class="bg-gray-600 hover:bg-gray-700 text-white px-4 py-2 rounded-lg transition">
                            â† è¿”å›ç”¨æˆ·åˆ—è¡¨
                        </button>
                        
                        <div class="bg-slate-800 border border-purple-500 rounded-lg p-6 shadow-xl">
                            <h2 class="text-2xl font-bold text-white mb-4">ğŸ‘¤ ç”¨æˆ·è¯¦æƒ…</h2>
                            <div class="grid grid-cols-2 gap-4 text-gray-300">
                                <div><span class="text-gray-500">ID:</span> <span class="text-white font-bold">${user.id}</span></div>
                                <div><span class="text-gray-500">é‚®ç®±:</span> <span class="text-white font-mono">${user.email}</span></div>
                                <div><span class="text-gray-500">è§’è‰²:</span> <span class="${user.is_admin ? 'text-orange-400' : 'text-blue-400'} font-bold">${user.is_admin ? 'ğŸ‘‘ ç®¡ç†å‘˜' : 'ğŸ‘¤ æ™®é€šç”¨æˆ·'}</span></div>
                                <div><span class="text-gray-500">2FA:</span> <span class="${user.two_factor_enabled ? 'text-green-400' : 'text-gray-400'}">${user.two_factor_enabled ? 'âœ… å·²å¯ç”¨' : 'âŒ æœªå¯ç”¨'}</span></div>
                                <div><span class="text-gray-500">æ³¨å†Œæ—¶é—´:</span> <span class="text-white">${new Date(user.created_at).toLocaleString()}</span></div>
                                <div><span class="text-gray-500">å¯†ç æ•°é‡:</span> <span class="text-[#F48120] font-bold">${passwords.length}</span></div>
                            </div>
                        </div>

                        <div class="bg-slate-800 border border-purple-500 rounded-lg p-6 shadow-xl">
                            <h2 class="text-2xl font-bold text-white mb-4">ğŸ”‘ ç”¨æˆ·å¯†ç åˆ—è¡¨ (${passwords.length})</h2>
                            ${passwords.length === 0 ? '<p class="text-gray-400 text-center py-8">è¯¥ç”¨æˆ·æš‚æ— ä¿å­˜çš„å¯†ç </p>' : `
                                <div class="space-y-3 max-h-96 overflow-y-auto">
                                    ${passwords.map(p => `
                                        <div class="bg-slate-700 p-4 rounded-lg border border-purple-500">
                                            <div class="flex justify-between items-start">
                                                <div class="flex-1">
                                                    <p class="font-bold text-purple-300 text-lg">${p.website}</p>
                                                    ${p.username ? `<p class='text-sm text-blue-300 mt-1'>ğŸ‘¤ ${p.username}</p>` : ''}
                                                    ${p.tags ? `<p class='text-xs text-gray-400 mt-1'>ğŸ·ï¸ ${p.tags}</p>` : ''}
                                                    <p class="text-xs text-gray-500 mt-2">ğŸ“… ${new Date(p.created_at).toLocaleString()}</p>
                                                </div>
                                                <button onclick="manager.deletePasswordAsAdmin(${p.id}, ${user.id})" class="bg-red-600 hover:bg-red-700 text-white px-3 py-1 rounded text-sm" title="åˆ é™¤å¯†ç ">
                                                    ğŸ—‘ï¸
                                                </button>
                                            </div>
                                        </div>
                                    `).join('')}
                                </div>
                            `}
                        </div>
                    </div>
                `;
            }

            renderAdminPasswords() {
                return `
                    <div class="bg-slate-800 border border-purple-500 rounded-lg p-6 shadow-xl">
                        <h2 class="text-2xl font-bold text-white mb-6">ğŸ”‘ æ‰€æœ‰å¯†ç æ€»è§ˆ (${this.state.adminPasswords.length})</h2>
                        <div class="overflow-x-auto">
                            <table class="w-full">
                                <thead>
                                    <tr class="border-b border-gray-700">
                                        <th class="text-left py-3 px-4 text-gray-400 font-semibold">ID</th>
                                        <th class="text-left py-3 px-4 text-gray-400 font-semibold">ç½‘ç«™</th>
                                        <th class="text-left py-3 px-4 text-gray-400 font-semibold">ç”¨æˆ·å</th>
                                        <th class="text-left py-3 px-4 text-gray-400 font-semibold">æ‰€å±ç”¨æˆ·</th>
                                        <th class="text-left py-3 px-4 text-gray-400 font-semibold">æ ‡ç­¾</th>
                                        <th class="text-left py-3 px-4 text-gray-400 font-semibold">åˆ›å»ºæ—¶é—´</th>
                                        <th class="text-left py-3 px-4 text-gray-400 font-semibold">æ“ä½œ</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${this.state.adminPasswords.map(p => `
                                        <tr class="border-b border-gray-700 hover:bg-slate-700 transition">
                                            <td class="py-3 px-4 text-white">${p.id}</td>
                                            <td class="py-3 px-4 text-purple-300 font-semibold">${p.website}</td>
                                            <td class="py-3 px-4 text-blue-300 font-mono text-sm">${p.username || '-'}</td>
                                            <td class="py-3 px-4">
                                                <button onclick="manager.viewUserDetails(${p.user_id})" class="text-white hover:text-blue-400 font-mono text-sm underline">${p.user_email}</button>
                                                <div class="text-xs text-gray-500">ID: ${p.user_id}</div>
                                            </td>
                                            <td class="py-3 px-4 text-gray-400 text-sm">${p.tags || '-'}</td>
                                            <td class="py-3 px-4 text-gray-400 text-sm">${new Date(p.created_at).toLocaleDateString()}</td>
                                            <td class="py-3 px-4">
                                                <button onclick="manager.deletePasswordAsAdmin(${p.id}, ${p.user_id})" class="bg-red-600 hover:bg-red-700 text-white px-3 py-1 rounded text-sm" title="åˆ é™¤å¯†ç ">
                                                    ğŸ—‘ï¸
                                                </button>
                                            </td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    </div>
                `;
            }

            renderLoginScreen() {
                return `
                    <div class="min-h-screen bg-gradient-to-br from-slate-900 via-purple-900 to-slate-900 flex items-center justify-center p-6">
                        <div class="bg-slate-800 border border-purple-500 rounded-lg p-8 shadow-2xl max-w-md w-full">
                            <h1 class="text-4xl font-bold text-white mb-2 text-center">ğŸ” PassFortress</h1>
                            <p class="text-purple-300 text-center mb-8">Secure Password Manager</p>
                            <div class="space-y-4">
                                <input type="email" placeholder="Email" class="w-full bg-slate-700 text-white p-3 rounded-lg border border-purple-500 focus:outline-none focus:border-pink-500" id="login-email" />
                                <input type="password" placeholder="Password" class="w-full bg-slate-700 text-white p-3 rounded-lg border border-purple-500 focus:outline-none focus:border-pink-500" id="login-password" />
                                <button onclick="manager.login()" class="w-full bg-gradient-to-r from-purple-600 to-pink-600 hover:from-purple-700 hover:to-pink-700 text-white font-bold py-3 px-6 rounded-lg transition">
                                    ğŸ”“ Login
                                </button>
                                <button onclick="manager.state.screen = 'register'; manager.render()" class="w-full bg-slate-700 hover:bg-slate-600 text-white font-bold py-3 px-6 rounded-lg transition">
                                    âœï¸ Create Account
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            }

            renderRegisterScreen() {
                return `
                    <div class="min-h-screen bg-gradient-to-br from-slate-900 via-purple-900 to-slate-900 flex items-center justify-center p-6">
                        <div class="bg-slate-800 border border-purple-500 rounded-lg p-8 shadow-2xl max-w-md w-full">
                            <h1 class="text-4xl font-bold text-white mb-2 text-center">ğŸ” PassFortress</h1>
                            <p class="text-purple-300 text-center mb-8">Create Your Account</p>
                            <div class="space-y-4">
                                <input type="email" placeholder="Email" class="w-full bg-slate-700 text-white p-3 rounded-lg border border-purple-500 focus:outline-none focus:border-pink-500" id="register-email" />
                                <input type="password" placeholder="Password" class="w-full bg-slate-700 text-white p-3 rounded-lg border border-purple-500 focus:outline-none focus:border-pink-500" id="register-password" />
                                <button onclick="manager.register()" class="w-full bg-gradient-to-r from-green-600 to-emerald-600 hover:from-green-700 hover:to-emerald-700 text-white font-bold py-3 px-6 rounded-lg transition">
                                    âœ… Register
                                </button>
                                <button onclick="manager.state.screen = 'login'; manager.render()" class="w-full bg-slate-700 hover:bg-slate-600 text-white font-bold py-3 px-6 rounded-lg transition">
                                    ğŸ”“ Back to Login
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            }

            renderAppScreen() {
                const strength = this.state.generatedPassword ? this.calculatePasswordStrength(this.state.generatedPassword) : null;
                const sortedPasswords = [...this.state.passwords].sort((a, b) => {
                    const aFav = this.state.favorites.includes(a.id);
                    const bFav = this.state.favorites.includes(b.id);
                    if (aFav && !bFav) return -1;
                    if (!aFav && bFav) return 1;
                    return 0;
                });
                
                return `
                    <div class="min-h-screen bg-gradient-to-br from-[#0F1E2E] via-slate-900 to-[#0F1E2E] p-6">
                        <div class="max-w-5xl mx-auto">
                            <!-- Header -->
                            <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-6 gap-4">
                                <div>
                                    <h1 class="text-3xl sm:text-4xl font-bold text-white mb-1">ğŸ” PassFortress</h1>
                                    <p class="text-gray-400 text-xs sm:text-sm">æ¬¢è¿ï¼Œ<span class="text-[#F48120] font-semibold">${this.state.user.email}</span></p>
                                    <p class="text-gray-500 text-[10px] mt-0.5">${this.state.clientInfo.isMobile ? 'ğŸ“±' : 'ğŸ’»'} ${this.state.clientInfo.platform} Â· ${this.state.clientInfo.browser}</p>
                                </div>
                                <div class="flex flex-wrap gap-2">
                                    ${this.isAdmin() ? `
                                        <button onclick="manager.state.screen='admin'; manager.switchAdminView('dashboard'); manager.render()" class="icon-btn btn-hover bg-gradient-to-r from-orange-600 to-yellow-600 hover:from-orange-700 hover:to-yellow-700 text-white py-2 px-3 rounded-lg transition font-bold" title="ç®¡ç†å‘˜é¢æ¿">
                                            ğŸ‘‘
                                        </button>
                                    ` : ''}
                                    <button onclick="manager.toggleTheme()" class="icon-btn btn-hover bg-slate-700 hover:bg-slate-600 text-white py-2 px-3 rounded-lg transition" title="ä¸»é¢˜">
                                        ${this.state.theme === 'dark' ? 'â˜€ï¸' : 'ğŸŒ™'}
                                    </button>
                                    <button onclick="manager.exportPasswords()" class="icon-btn btn-hover bg-blue-600 hover:bg-blue-700 text-white py-2 px-3 rounded-lg transition" title="å¯¼å‡º">
                                        ğŸ“¦
                                    </button>
                                    <button onclick="manager.importPasswords()" class="icon-btn btn-hover bg-green-600 hover:bg-green-700 text-white py-2 px-3 rounded-lg transition" title="å¯¼å…¥">
                                        ğŸ“¥
                                    </button>
                                    <button onclick="manager.open2FA()" class="icon-btn btn-hover bg-indigo-600 hover:bg-indigo-700 text-white py-2 px-3 rounded-lg transition" title="2FA">
                                        ${this.state.twoFAEnabled ? 'ğŸ”’' : 'ğŸ”'}
                                    </button>
                                    <button onclick="manager.logout()" class="icon-btn btn-hover bg-red-600 hover:bg-red-700 text-white py-2 px-3 rounded-lg transition" title="é€€å‡º">ğŸšª</button>
                                </div>
                            </div>
                            <div class="flex flex-col lg:flex-row gap-6">
                                <!-- Left: Search & Passwords List -->
                                <div class="flex-1 space-y-6">
                                    <div class="bg-slate-800 border border-purple-500 rounded-lg p-6 shadow-2xl h-full">
                                        <div class="flex justify-between items-center mb-4">
                                            <h2 class="text-2xl font-bold text-white">ğŸ”‘ å·²ä¿å­˜å¯†ç  (${this.state.passwords.length})</h2>
                                            <div class="flex items-center gap-2">
                                                ${this.state.selectedIds.length > 0 ? `<span class='text-xs text-gray-300'>å·²é€‰ ${this.state.selectedIds.length}</span>` : ''}
                                                <button onclick="manager.clearSelection()" class="bg-slate-600 hover:bg-slate-500 text-white px-3 py-1 rounded text-xs" title="æ¸…é™¤é€‰æ‹©">ğŸ§¹</button>
                                                <button onclick="manager.bulkExport()" class="bg-blue-600 hover:bg-blue-700 text-white px-3 py-1 rounded text-xs" title="å¯¼å‡ºé€‰ä¸­" ${this.state.selectedIds.length===0?'disabled style=\'opacity:.4;cursor:not-allowed;\'' : ''}>ğŸ“¦</button>
                                                <button onclick="manager.bulkDelete()" class="bg-red-600 hover:bg-red-700 text-white px-3 py-1 rounded text-xs" title="åˆ é™¤é€‰ä¸­" ${this.state.selectedIds.length===0?'disabled style=\'opacity:.4;cursor:not-allowed;\'' : ''}>ğŸ—‘ï¸</button>
                                            </div>
                                        </div>
                                        <input type="text" placeholder="ğŸ” æœç´¢å¯†ç ..." value="${this.state.searchQuery}" 
                                            oninput="manager.searchPasswords(this.value)" 
                                            class="w-full bg-slate-700 text-white p-3 rounded-lg border border-purple-500 focus:outline-none focus:border-pink-500 mb-4" />
                                        <div class="space-y-3 max-h-[560px] overflow-y-auto pr-1">
                                            ${this.state.passwords.length === 0 ? 
                                                '<p class="text-gray-400 text-center py-8">æš‚æ— å¯†ç ã€‚</p>' : 
                                                sortedPasswords.map(p => {
                                                    const age = this.getPasswordAge(p.created_at);
                                                    const isFavorite = this.state.favorites.includes(p.id);
                                                    return `
                                                    <div class="password-item bg-slate-700 p-4 rounded-lg border ${isFavorite ? 'border-yellow-500' : 'border-purple-500'} transition-all">
                                                        <div class="flex justify-between items-start mb-2">
                                                            <div class="flex-1">
                                                                <div class="flex items-center gap-2">
                                                                    <input type='checkbox' onclick="manager.toggleSelect(${p.id})" ${this.state.selectedIds.includes(p.id)?'checked':''} class='accent-[#F48120] w-4 h-4' title='é€‰æ‹©' />
                                                                    <button onclick="manager.toggleFavorite(${p.id})" class="text-2xl" title="${isFavorite ? 'ç§»å‡ºæ”¶è—' : 'åŠ å…¥æ”¶è—'}">
                                                                        ${isFavorite ? 'â­' : 'â˜†'}
                                                                    </button>
                                                                    <p class="font-bold text-purple-300 text-lg truncate max-w-[180px]" title="${p.website}">${p.website}</p>
                                                                </div>
                                                                <p class="text-sm text-gray-400 font-mono ml-8 break-all">${this.state.visiblePasswords[p.id] ? p.password : 'â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢'}</p>
                                                                ${p.username ? `<p class='text-xs text-blue-300 ml-8 break-all'>ğŸ‘¤ ${p.username}</p>` : ''}
                                                                <div class="flex items-center gap-3 mt-2 ml-8">
                                                                    <p class="text-xs text-gray-500">ğŸ“… ${new Date(p.created_at).toLocaleDateString()}</p>
                                                                    <p class="text-xs" style="color: ${age.color === 'red' ? '#f87171' : age.color === 'yellow' ? '#facc15' : '#4ade80'}">${age.warning ? 'âš ï¸ ' : ''}${age.text}</p>
                                                                </div>
                                                            </div>
                                                            <div class="flex flex-wrap gap-1">
                                                                <button onclick="manager.togglePasswordVisibility(${p.id})" class="bg-purple-600 hover:bg-purple-700 text-white px-2 py-1.5 rounded-lg transition text-xs" title="${this.state.visiblePasswords[p.id] ? 'éšè—' : 'æ˜¾ç¤º'}">
                                                                    ${this.state.visiblePasswords[p.id] ? 'ğŸ‘ï¸' : 'ğŸ”’'}
                                                                </button>
                                                                <button onclick="manager.copyToClipboard('${p.password}')" class="bg-blue-600 hover:bg-blue-700 text-white px-2 py-1.5 rounded-lg transition text-xs" title="å¤åˆ¶">
                                                                    ğŸ“‹
                                                                </button>
                                                                <button onclick="manager.startEditPassword(${p.id}, '${p.website}', '${p.password}', '${(p.username||'').replace(/'/g, "&#39;")}')" class="bg-cyan-600 hover:bg-cyan-700 text-white px-2 py-1.5 rounded-lg transition text-xs" title="ç¼–è¾‘">
                                                                    âœï¸
                                                                </button>
                                                                <button onclick="manager.deletePassword(${p.id})" class="bg-red-600 hover:bg-red-700 text-white px-2 py-1.5 rounded-lg transition text-xs" title="åˆ é™¤">
                                                                    ğŸ—‘ï¸
                                                                </button>
                                                            </div>
                                                        </div>
                                                    </div>
                                                `}).join('')
                                            }
                                        </div>
                                    </div>
                                </div>
                                <!-- Right: Generator + Save/Edit -->
                                <div class="w-full lg:w-[420px] space-y-6">
                                    <div class="panel-scroll bg-slate-800 border border-purple-500 rounded-lg p-6 shadow-2xl">
                                        <div class="flex justify-between items-center mb-4">
                                            <h2 class="text-2xl font-bold text-white">ğŸ² ç”Ÿæˆå¼ºå¯†ç </h2>
                                            <button onclick="manager.state.showSettings = !manager.state.showSettings; manager.render()" class="text-purple-300 hover:text-purple-100">
                                                âš™ï¸ è®¾ç½®
                                            </button>
                                        </div>
                                        ${this.state.showSettings ? `
                                            <div class="panel-inner bg-slate-700 p-4 rounded-lg mb-4 space-y-3">
                                                <div class="flex items-center justify-between">
                                                    <label class="text-white">é•¿åº¦: ${this.state.passwordLength}</label>
                                                    <input type="range" min="8" max="32" value="${this.state.passwordLength}" onchange="manager.state.passwordLength = parseInt(this.value); manager.render()" class="w-48" />
                                                </div>
                                                <div class="grid grid-cols-2 gap-2">
                                                    <label class="flex items-center text-white cursor-pointer">
                                                        <input type="checkbox" ${this.state.includeUppercase ? 'checked' : ''} onchange="manager.state.includeUppercase = this.checked; manager.render()" class="mr-2" /> å¤§å†™ (A-Z)
                                                    </label>
                                                    <label class="flex items-center text-white cursor-pointer">
                                                        <input type="checkbox" ${this.state.includeLowercase ? 'checked' : ''} onchange="manager.state.includeLowercase = this.checked; manager.render()" class="mr-2" /> å°å†™ (a-z)
                                                    </label>
                                                    <label class="flex items-center text-white cursor-pointer">
                                                        <input type="checkbox" ${this.state.includeNumbers ? 'checked' : ''} onchange="manager.state.includeNumbers = this.checked; manager.render()" class="mr-2" /> æ•°å­— (0-9)
                                                    </label>
                                                    <label class="flex items-center text-white cursor-pointer">
                                                        <input type="checkbox" ${this.state.includeSymbols ? 'checked' : ''} onchange="manager.state.includeSymbols = this.checked; manager.render()" class="mr-2" /> ç¬¦å· (!@#)
                                                    </label>
                                                </div>
                                            </div>
                                        ` : ''}
                                        <button onclick="manager.generatePassword()" class="w-full bg-gradient-to-r from-purple-600 to-pink-600 hover:from-purple-700 hover:to-pink-700 text-white font-bold py-3 px-6 rounded-lg transition mb-3">ğŸ² ç”Ÿæˆå¯†ç </button>
                                        ${this.state.generatedPassword ? `
                                            <div class="space-y-2">
                                                ${strength ? `
                                                    <div class="flex items-center gap-2">
                                                        <div class="flex-1 bg-slate-700 rounded-full h-2">
                                                            <div class="h-2 rounded-full transition-all" style="width: ${strength.level === 'weak' ? '33%' : strength.level === 'medium' ? '66%' : '100%'}; background-color: ${strength.color === 'red' ? '#ef4444' : strength.color === 'yellow' ? '#eab308' : '#22c55e'}"></div>
                                                        </div>
                                                        <span class="font-bold text-sm" style="color: ${strength.color === 'red' ? '#f87171' : strength.color === 'yellow' ? '#facc15' : '#4ade80'}">${strength.text}</span>
                                                    </div>
                                                ` : ''}
                                                <div class="flex gap-2">
                                                    <input type="${this.state.showGeneratedPassword ? 'text' : 'password'}" value="${this.state.generatedPassword}" readonly class="mono-wrap flex-1 bg-slate-700 text-white p-3 rounded-lg border border-purple-500 font-mono" />
                                                    <button onclick="manager.toggleGeneratedPasswordVisibility()" class="btn-hover bg-purple-600 hover:bg-purple-700 text-white font-bold py-3 px-4 rounded-lg transition" title="${this.state.showGeneratedPassword ? 'éšè—' : 'æ˜¾ç¤º'}">${this.state.showGeneratedPassword ? 'ğŸ‘ï¸' : 'ğŸ”’'}</button>
                                                    <button onclick="manager.copyToClipboard('${this.state.generatedPassword}')" class="btn-hover bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-lg transition" title="å¤åˆ¶">ğŸ“‹</button>
                                                    <button onclick="manager.useGeneratedPassword()" class="btn-hover bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-4 rounded-lg transition" title="ä½¿ç”¨">âœ…</button>
                                                </div>
                                            </div>
                                        ` : ''}
                                    </div>
                                    <div class="bg-slate-800 border border-purple-500 rounded-lg p-6 shadow-2xl">
                                        <h2 class="text-2xl font-bold text-white mb-4">${this.state.editingPasswordId ? 'âœï¸ ç¼–è¾‘å¯†ç ' : 'ğŸ’¾ ä¿å­˜å¯†ç '}</h2>
                                        <div class="space-y-3">
                                            <div class="flex gap-2">
                                                <input type="text" placeholder="ç½‘ç«™ (ä¾‹å¦‚ï¼šgmail.com)" value="${this.state.newWebsite}" class="w-1/2 bg-slate-700 text-white p-3 rounded-lg border border-purple-500 focus:outline-none focus:border-pink-500" id="website" />
                                                <input type="text" placeholder="ç”¨æˆ·å (ä¾‹å¦‚ï¼šuser123)" value="${this.state.newUsername}" class="w-1/2 bg-slate-700 text-white p-3 rounded-lg border border-purple-500 focus:outline-none focus:border-pink-500" id="username" oninput="manager.state.newUsername=this.value" />
                                            </div>
                                            <input type="password" placeholder="å¯†ç " value="${this.state.newPassword}" class="w-full bg-slate-700 text-white p-3 rounded-lg border border-purple-500 focus:outline-none focus:border-pink-500 font-mono" id="password" />
                                            ${this.state.editingPasswordId ? `
                                                <div class="flex gap-2">
                                                    <button onclick="manager.updatePassword()" class="flex-1 bg-gradient-to-r from-blue-600 to-cyan-600 hover:from-blue-700 hover:to-cyan-700 text-white font-bold py-3 px-6 rounded-lg transition">âœï¸ æ›´æ–°å¯†ç </button>
                                                    <button onclick="manager.cancelEdit()" class="bg-slate-600 hover:bg-slate-500 text-white font-bold py-3 px-6 rounded-lg transition">âŒ å–æ¶ˆ</button>
                                                </div>
                                            ` : `
                                                <button onclick="manager.savePassword()" class="w-full bg-gradient-to-r from-green-600 to-emerald-600 hover:from-green-700 hover:to-emerald-700 text-white font-bold py-3 px-6 rounded-lg transition">ğŸ’¾ ä¿å­˜å¯†ç </button>
                                            `}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }
        }

        const manager = new PasswordManager();
        // åˆæ¬¡åŠ è½½æ¸²æŸ“ç•Œé¢
        manager.render();

        // Update input bindings
        setInterval(() => {
            const websiteInput = document.getElementById('website');
            const passwordInput = document.getElementById('password');
            const loginEmail = document.getElementById('login-email');
            const loginPassword = document.getElementById('login-password');
            const registerEmail = document.getElementById('register-email');
            const registerPassword = document.getElementById('register-password');

            if (websiteInput) websiteInput.addEventListener('input', (e) => { manager.state.newWebsite = e.target.value; });
            if (passwordInput) passwordInput.addEventListener('input', (e) => { manager.state.newPassword = e.target.value; });
            if (loginEmail) loginEmail.addEventListener('input', (e) => { manager.state.email = e.target.value; });
            if (loginPassword) loginPassword.addEventListener('input', (e) => { manager.state.password = e.target.value; });
            if (registerEmail) registerEmail.addEventListener('input', (e) => { manager.state.email = e.target.value; });
            if (registerPassword) registerPassword.addEventListener('input', (e) => { manager.state.password = e.target.value; });
        }, 100);

        // 2FA è¾…åŠ©å‡½æ•°
        PasswordManager.prototype.open2FA = async function() {
            try {
                // æŸ¥è¯¢ç”¨æˆ·æ˜¯å¦å¯ç”¨
                const res = await fetch(`${API_BASE}/api/auth/login`, { method:'OPTIONS' }) // å ä½å¯æ‰©å±•
            } catch {}
            if (!this.state.twoFAEnabled) {
                // åˆå§‹åŒ–é˜¶æ®µ
                this.state.twoFAStage = 'init';
                this.showToast('ç”ŸæˆäºŒæ¬¡éªŒè¯å¯†é’¥...', 'info');
                try {
                    const r = await fetch(`${API_BASE}/api/auth/2fa/init`, { method:'POST', headers:{'Authorization':`Bearer ${this.state.token}`}});
                    const data = await r.json();
                    if (r.ok) {
                        this.state.twoFASecret = data.secret;
                        this.state.twoFAOtpAuth = data.otpauth;
                        this.state.show2FAModal = true;
                        this.render();
                    } else {
                        this.showToast(data.error || 'Init failed','error');
                    }
                } catch(e){ this.showToast(e.message,'error'); }
            } else {
                this.state.twoFAStage = 'disable';
                this.state.show2FAModal = true;
                this.render();
            }
        }

        PasswordManager.prototype.activate2FA = async function() {
            if (!this.state.twoFACode) { this.showToast('è¯·è¾“å…¥éªŒè¯ç ','error'); return; }
            try {
                const r = await fetch(`${API_BASE}/api/auth/2fa/activate`, {
                    method:'POST',
                    headers:{'Authorization':`Bearer ${this.state.token}`, 'Content-Type':'application/json'},
                    body: JSON.stringify({ code: this.state.twoFACode })
                });
                const data = await r.json();
                if (r.ok) {
                    this.state.twoFAEnabled = true;
                    this.state.show2FAModal = false;
                    this.state.twoFAStage = 'idle';
                    this.state.twoFACode='';
                    // è‡ªåŠ¨ç”Ÿæˆæ¢å¤ç 
                    await this.generateRecoveryCodes();
                    this.showToast('2FA å·²å¯ç”¨','success');
                    this.render();
                } else this.showToast(data.error || 'å¯ç”¨å¤±è´¥','error');
            } catch(e){ this.showToast(e.message,'error'); }
        }

        PasswordManager.prototype.verifyLogin2FA = async function() {
            if (!this.state.twoFACode) { this.showToast('è¯·è¾“å…¥éªŒè¯ç ','error'); return; }
            try {
                const r = await fetch(`${API_BASE}/api/auth/2fa/verify`, {
                    method:'POST', headers:{'Content-Type':'application/json'},
                    body: JSON.stringify({ tempToken: this.state.twoFATempToken, code: this.state.twoFACode })
                });
                const data = await r.json();
                if (r.ok && data.token) {
                    this.state.token = data.token;
                    this.state.user = data.user;
                    localStorage.setItem('token', data.token);
                    localStorage.setItem('user', JSON.stringify(data.user));
                    this.state.screen='app';
                    this.state.show2FAModal=false;
                    this.state.twoFAStage='idle';
                    this.state.twoFATempToken='';
                    this.state.twoFACode='';
                    this.showToast('ç™»å½•æˆåŠŸ','success');
                    await this.loadPasswords();
                    this.render();
                } else this.showToast(data.error || 'éªŒè¯å¤±è´¥','error');
            } catch(e){ this.showToast(e.message,'error'); }
        }

        PasswordManager.prototype.disable2FA = async function() {
            if (!this.state.twoFACode) { this.showToast('è¯·è¾“å…¥éªŒè¯ç ','error'); return; }
            try {
                const r = await fetch(`${API_BASE}/api/auth/2fa/disable`, {
                    method:'POST', headers:{'Authorization':`Bearer ${this.state.token}`, 'Content-Type':'application/json'},
                    body: JSON.stringify({ code: this.state.twoFACode })
                });
                const data = await r.json();
                if (r.ok) {
                    this.state.twoFAEnabled = false;
                    this.state.show2FAModal=false;
                    this.state.twoFAStage='idle';
                    this.state.twoFACode='';
                    this.showToast('2FA å·²å…³é—­','success');
                    this.render();
                } else this.showToast(data.error || 'å…³é—­å¤±è´¥','error');
            } catch(e){ this.showToast(e.message,'error'); }
        }

        PasswordManager.prototype.close2FAModal = function(){
            this.state.show2FAModal=false; this.state.twoFAStage='idle'; this.state.twoFACode=''; this.render();
        }

        // ä½¿ç”¨ QRCode.js ç”Ÿæˆæ ‡å‡†äºŒç»´ç  (å…¼å®¹ Google Authenticator)
        PasswordManager.prototype.generateQR = function() {
            const container = document.getElementById('qrcode');
            if (!container || !this.state.twoFAOtpAuth) return;
            // æ¸…ç©ºå®¹å™¨
            container.innerHTML = '';
            try {
                // ç”ŸæˆäºŒç»´ç 
                new QRCode(container, {
                    text: this.state.twoFAOtpAuth,
                    width: 200,
                    height: 200,
                    colorDark: '#0F1E2E',
                    colorLight: '#ffffff',
                    correctLevel: QRCode.CorrectLevel.M
                });
            } catch(e) {
                // é™çº§æ˜¾ç¤º URI
                container.innerHTML = `<div class='text-xs text-gray-400 p-2 bg-slate-700 rounded break-all'>${this.state.twoFAOtpAuth}</div>`;
            }
        }
    </script>
</body>
</html>
